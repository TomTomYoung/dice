%%html
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSS3D ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3ãƒªãƒ¼ãƒ«ï¼æ¼”å‡ºâ†’æœ¬ç•ªã‚¹ãƒ”ãƒ³ï¼‰</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e5e7eb; --muted:#94a3b8; --acc:#7aa2f7;
    --card:#121620; --border:#263042;
    --reel-w:120px; --reel-h:160px;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI",sans-serif}
  .app{max-width:880px;margin:24px auto;padding:16px}
  .panel{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:6px 0 14px}
  .panel input,.panel select,.panel button{background:#0d121a;border:1px solid var(--border);color:var(--fg);padding:6px 10px;border-radius:8px}
  .panel button{cursor:pointer}
  .muted{color:var(--muted)}
  .sep{height:1px;background:var(--border);margin:14px 0}

  .stage{
    margin:auto; width:calc(var(--reel-w)*3 + 64px);
    perspective:1000px; background:linear-gradient(#0b0e14,#101722);
    border:1px solid var(--border); border-radius:16px; padding:24px 18px; position:relative;
  }
  .slots{display:flex;justify-content:center;gap:24px;align-items:center}
  .reel-wrap{
    width:var(--reel-w); height:var(--reel-h); position:relative; overflow:hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    border-radius:12px;
  }
  .reel{width:100%;height:100%;position:relative;transform-style:preserve-3d;will-change:transform}
  .face{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:28px; letter-spacing:1px;
    background:radial-gradient(120% 120% at 50% -20%, #1c2433 0%, #0e1420 60%);
    border:1px solid #1f2a3c; border-radius:12px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 10px 24px rgba(0,0,0,.35);
    backface-visibility:hidden;
  }
  .reel-wrap::after{ /* ç«¯ã®ã«ã˜ã¿éš ã—ï¼ˆä»»æ„ï¼‰ */
    content:""; position:absolute; inset:0; pointer-events:none;
    background:linear-gradient(to bottom, rgba(0,0,0,.45), transparent 26%, transparent 74%, rgba(0,0,0,.45));
  }
  .arm{
    position:absolute; inset:0; pointer-events:none;
    border:2px dashed rgba(122,162,247,.18); border-left:none; border-right:none;
    top:50%; height:0; transform:translateY(-50%);
  }
  .glow{
    position:absolute; left:0; right:0; top:50%; height:2px; transform:translateY(-1px);
    background:linear-gradient(90deg, transparent, rgba(122,162,247,.7), transparent);
    filter:drop-shadow(0 0 6px rgba(122,162,247,.6)); opacity:.7;
  }
  .result{margin-top:14px; text-align:center; font-size:16px; font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <button id="spin">ã‚¹ãƒ”ãƒ³</button>
    <button id="stop" disabled>é †æ¬¡ã‚¹ãƒˆãƒƒãƒ—</button>
    <label>å›è»¢é‡ä¿‚æ•°
      <input id="turns" type="number" min="2" max="20" step="1" value="8" style="width:64px">
    </label>
    <label>æ¸›é€Ÿæ™‚é–“(ms)
      <input id="dur" type="number" min="400" max="6000" step="100" value="2000" style="width:80px">
    </label>
    <label>ãƒªãƒ¼ãƒ«é–“é…å»¶(ms)
      <input id="stagger" type="number" min="0" max="1500" step="50" value="250" style="width:72px">
    </label>
    <label>æ¼”å‡ºå›è»¢ n
      <input id="warmup" type="number" min="0" max="30" step="1" value="6" style="width:56px">
    </label>
    <span class="muted">ï¼ˆCSS3D / rotateXï¼‰</span>
  </div>

  <div class="stage">
    <div class="arm"></div>
    <div class="glow"></div>
    <div class="slots" id="slots"></div>
    <div class="result" id="result">â€”</div>
  </div>

  <div class="sep"></div>
  <div class="panel">
    <label>å›³æŸ„ã‚»ãƒƒãƒˆ
      <select id="symbolsPreset">
        <option value="classic">ã‚¯ãƒ©ã‚·ãƒƒã‚¯ï¼ˆBAR/7/ğŸ’/ğŸ””/ğŸ‹/ğŸ‰ ãªã©ï¼‰</option>
        <option value="fruits">ãƒ•ãƒ«ãƒ¼ãƒ„</option>
        <option value="numbers">æ•°å­—</option>
      </select>
    </label>
    <button id="apply">é©ç”¨</button>
    <span class="muted">â€» é¢æ•°ã¯å›³æŸ„æ•°ä»¥ä¸Šã§è‡ªå‹•èª¿æ•´ï¼ˆæ—¢å®š12ï¼‰ã€‚</span>
  </div>
</div>

<script>
/* ===== å›³æŸ„å®šç¾© ===== */
const PRESETS = {
  classic: ["BAR","7","ğŸ’","ğŸ””","ğŸ‹","ğŸ‰","â­","ğŸ‡","ğŸŠ","ğŸ’","ğŸ€"],
  fruits:  ["ğŸ’","ğŸ‹","ğŸ","ğŸ‡","ğŸ“","ğŸ‰","ğŸ","ğŸ¥","ğŸ‘","ğŸŠ","â­","ğŸ’"],
  numbers: ["1","2","3","4","5","6","7","8","9","â˜…","â—","â—‡"],
};
const REELS = 3;
let SYMBOLS = PRESETS.classic.slice();
let FACES   = Math.max(12, SYMBOLS.length);

/* ===== æ§‹ç¯‰ ===== */
const $slots = document.getElementById('slots');
const reels = []; // {wrap, reel, faces[], step, radius, turn, spinning, promise, raf}
function build(){
  $slots.innerHTML=''; reels.length=0;
  for(let r=0;r<REELS;r++){
    const wrap = document.createElement('div');
    wrap.className='reel-wrap';
    const reel = document.createElement('div');
    reel.className='reel';
    wrap.appendChild(reel); $slots.appendChild(wrap);

    const H = parseFloat(getComputedStyle(wrap).height);
    const step = 360 / FACES;
    const radius = H/2 / Math.tan(Math.PI / FACES);

    const faces=[];
    for(let i=0;i<FACES;i++){
      const f=document.createElement('div');
      f.className='face';
      f.textContent = SYMBOLS[i % SYMBOLS.length];
      const rot=i*step;
      f.style.transform=`rotateX(${rot}deg) translateZ(${radius.toFixed(2)}px)`;
      reel.appendChild(f); faces.push(f);
    }
    reel.style.transform='rotateX(0deg)';
    reels.push({wrap,reel,faces,step,radius,turn:0,spinning:false,promise:null,raf:null});
  }
}
build();

/* ===== ã‚¤ãƒ¼ã‚¸ãƒ³ã‚° ===== */
const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

/* ===== ãƒ©ãƒ³ãƒ€ãƒ çµæœ ===== */
function getRandomResult(){
  return Array.from({length:REELS}, ()=> Math.floor(Math.random()*SYMBOLS.length));
}
function faceIndexForSymbolIndex(i){ return i; }

/* ===== äºŒæ®µã‚¢ãƒ‹ãƒ¡ï¼šæ¼”å‡ºâ†’æœ¬ç•ª ===== */
function animateReelTwoPhase(r, warmupTurns, finalTargetDeg, finalDuration, delay){
  r.spinning = true;
  let resolveFn; r.promise = new Promise(res=>resolveFn=res);

  const startDeg = r.turn;
  const warmupTarget = startDeg - 360*warmupTurns;
  const warmupPerTurnMs = 220;
  const warmupDuration = Math.max(200, warmupTurns*warmupPerTurnMs);

  let t0=null;
  function warmupStep(ts){
    if(!t0){ t0 = ts + (delay||0); }
    const t = ts - t0;
    if(t<0){ r.raf=requestAnimationFrame(warmupStep); return; }
    const p = Math.min(1, t/warmupDuration);
    const deg = startDeg + (warmupTarget-startDeg)*p; // ç·šå½¢
    r.turn = deg; r.reel.style.transform=`rotateX(${deg}deg)`;
    if(p<1){ r.raf=requestAnimationFrame(warmupStep); }
    else{
      // è¦‹ãŸç›®ã‚’ä¿ã£ãŸã¾ã¾è§’åº¦çŠ¶æ…‹ã ã‘åˆæœŸåŒ–
      r.turn = startDeg; r.reel.style.transform=`rotateX(${startDeg}deg)`;
      let s1=null;
      function mainStep(ts2){
        if(!s1){ s1=ts2; }
        const t2 = ts2 - s1;
        const p2 = Math.min(1, t2/finalDuration);
        const eased = easeOutCubic(p2);
        const deg2 = startDeg + (finalTargetDeg-startDeg)*eased;
        r.turn = deg2; r.reel.style.transform=`rotateX(${deg2}deg)`;
        if(p2<1){ r.raf=requestAnimationFrame(mainStep); }
        else{
          r.spinning=false; r.turn=finalTargetDeg; r.reel.style.transform=`rotateX(${finalTargetDeg}deg)`;
          resolveFn();
        }
      }
      r.raf=requestAnimationFrame(mainStep);
    }
  }
  r.raf=requestAnimationFrame(warmupStep);
}

/* ===== ã‚¹ãƒ”ãƒ³ï¼é †æ¬¡ã‚¹ãƒˆãƒƒãƒ— ===== */
const btnSpin = document.getElementById('spin');
const btnStop = document.getElementById('stop');
const inputTurns = document.getElementById('turns');
const inputDur = document.getElementById('dur');
const inputStagger = document.getElementById('stagger');
const inputWarmup = document.getElementById('warmup');
const $result = document.getElementById('result');

function spinAll(){
  if(reels.some(r=>r.spinning)) return;
  const TURNS = Math.max(2, Math.min(20, parseInt(inputTurns.value)||8));
  const DUR   = Math.max(400, Math.min(6000, parseInt(inputDur.value)||2000));
  const STAG  = Math.max(0, Math.min(1500, parseInt(inputStagger.value)||250));
  const WARM  = Math.max(0, Math.min(30, parseInt(inputWarmup.value)||0));

  const resultIdx = getRandomResult();
  const resultSym = resultIdx.map(i=>SYMBOLS[i]);

  reels.forEach((r, ri)=>{
    const faceIdx = faceIndexForSymbolIndex(resultIdx[ri]) % r.faces.length;
    const baseTarget = -faceIdx * r.step;
    const extraTurns = (TURNS + ri);
    const targetDeg = baseTarget - 360 * extraTurns;
    animateReelTwoPhase(r, WARM, targetDeg, DUR + ri*120, STAG*ri);
  });

  btnSpin.disabled=true; btnStop.disabled=false; $result.textContent='ã‚¹ãƒ”ãƒ³ä¸­â€¦';
  Promise.all(reels.map(r=>r.promise)).then(()=>{
    $result.textContent = `çµæœ: [ ${resultSym.join(' | ')} ]`;
    btnSpin.disabled=false; btnStop.disabled=true;
  });
}

function stopSequential(){
  const DUR = Math.max(400, Math.min(6000, parseInt(inputDur.value)||2000));
  const STAG= Math.max(0, Math.min(1500, parseInt(inputStagger.value)||250));
  const WARM= Math.max(0, Math.min(30, parseInt(inputWarmup.value)||0));

  const picks = getRandomResult();
  reels.forEach((r,i)=>{
    const idx = faceIndexForSymbolIndex(picks[i]) % r.faces.length;
    const baseTarget = -idx * r.step;
    const now = r.turn;
    const turnsAhead = 2 + i;
    let targetDeg = baseTarget - 360 * turnsAhead;
    while (targetDeg > now - 360) targetDeg -= 360;
    animateReelTwoPhase(r, WARM, targetDeg, DUR + i*160, STAG*i);
  });

  btnStop.disabled = true;
}

btnSpin.onclick = spinAll;
btnStop.onclick = stopSequential;

/* ===== å›³æŸ„ã‚»ãƒƒãƒˆåˆ‡æ›¿ ===== */
document.getElementById('apply').onclick=()=>{
  const v = document.getElementById('symbolsPreset').value;
  SYMBOLS = PRESETS[v].slice();
  FACES = Math.max(12, SYMBOLS.length);
  build(); $result.textContent='â€”';
};

/* ===== ãƒªã‚µã‚¤ã‚ºæ™‚ã®åŠå¾„æ›´æ–° ===== */
addEventListener('resize', ()=>{
  reels.forEach(r=>{
    const H = parseFloat(getComputedStyle(r.wrap).height);
    const radius = H/2 / Math.tan(Math.PI / FACES);
    r.faces.forEach((f,i)=>{
      f.style.transform = `rotateX(${i*r.step}deg) translateZ(${radius.toFixed(2)}px)`;
    });
    r.reel.style.transform = `rotateX(${r.turn}deg)`;
  });
});
</script>
</body>
</html>
