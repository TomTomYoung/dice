<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSS3Dã‚µã‚¤ã‚³ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
  :root {
    --size: 90px;
    --pip: 12px;
    --gap: 16px;
  }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    margin: 0;
    padding: 24px;
    background: #eef2ff;
    color: #0f172a;
  }
  .container {
    max-width: 1100px;
    margin: 0 auto;
  }
  header {
    background: white;
    padding: 24px;
    border-radius: 14px;
    margin-bottom: 24px;
    box-shadow: 0 12px 40px rgba(99, 102, 241, .18);
  }
  h1 {
    margin: 0 0 12px;
    font-size: 28px;
    font-weight: 700;
  }
  .lead {
    margin: 0;
    color: #475569;
    font-size: 15px;
  }
  .config-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .config-group {
    background: white;
    padding: 18px;
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, .12);
    box-shadow: 0 8px 24px rgba(79, 70, 229, .12);
  }
  .config-group h3 {
    margin: 0 0 12px;
    font-size: 14px;
    font-weight: 700;
    color: #4338ca;
    letter-spacing: .4px;
  }
  .radio-group,
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .radio-item,
  .checkbox-item,
  .number-input {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .radio-item,
  .checkbox-item {
    padding: 6px;
    border-radius: 8px;
    transition: background .15s;
  }
  .radio-item:hover,
  .checkbox-item:hover {
    background: rgba(99,102,241,.08);
  }
  .number-input {
    margin-bottom: 10px;
  }
  .number-input label {
    min-width: 90px;
    font-size: 14px;
  }
  .number-input input {
    flex: 1;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #c7d2fe;
    font-size: 14px;
  }
  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 16px;
  }
  button {
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: transform .15s, box-shadow .15s;
  }
  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #4338ca);
    color: white;
    box-shadow: 0 12px 30px rgba(79,70,229,.28);
  }
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 14px 36px rgba(79,70,229,.32);
  }
  .btn-primary:disabled {
    background: #94a3b8;
    box-shadow: none;
    cursor: not-allowed;
  }
  .btn-secondary {
    background: #0f172a;
    color: white;
  }
  .btn-secondary:hover {
    transform: translateY(-1px);
  }
  .dice-container {
    background: white;
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(59, 130, 246, 0.18);
    min-height: 240px;
  }
  .board-3d {
    display: flex;
    gap: var(--gap);
    perspective: 1100px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .die-wrap-3d {
    width: var(--size);
    height: var(--size);
    position: relative;
  }
  .cube {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
  }
  .face {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    background: radial-gradient(120% 120% at 30% 20%, rgba(226,232,240,0.9), rgba(15,23,42,0.05));
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, .7);
    box-shadow: inset 0 0 10px rgba(15,23,42,.12);
  }
  .pip {
    width: var(--pip);
    height: var(--pip);
    background: #0f172a;
    border-radius: 50%;
    margin: auto;
  }
  .p1 { grid-area: 1 / 1; }
  .p2 { grid-area: 1 / 2; }
  .p3 { grid-area: 1 / 3; }
  .p4 { grid-area: 2 / 1; }
  .p5 { grid-area: 2 / 2; }
  .p6 { grid-area: 2 / 3; }
  .p7 { grid-area: 3 / 1; }
  .p8 { grid-area: 3 / 2; }
  .p9 { grid-area: 3 / 3; }
  .f-front  { transform: translateZ(calc(var(--size) / 2)); }
  .f-back   { transform: rotateY(180deg) translateZ(calc(var(--size) / 2)); }
  .f-right  { transform: rotateY(90deg) translateZ(calc(var(--size) / 2)); }
  .f-left   { transform: rotateY(-90deg) translateZ(calc(var(--size) / 2)); }
  .f-top    { transform: rotateX(90deg) translateZ(calc(var(--size) / 2)); }
  .f-bottom { transform: rotateX(-90deg) translateZ(calc(var(--size) / 2)); }
  .results {
    margin-top: 20px;
    padding: 16px;
    background: #eef2ff;
    border-radius: 12px;
    border: 1px solid #c7d2fe;
    color: #312e81;
    font-size: 15px;
    display: none;
  }
  .results-detail {
    margin-top: 4px;
    font-size: 14px;
    color: #3730a3;
  }
  .debug-controls {
    margin-top: 12px;
    padding: 12px;
    background: #fef3c7;
    border-radius: 8px;
    border: 1px solid #fcd34d;
    display: none;
  }
  .debug-controls label {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
  }
  .debug-inputs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .debug-inputs input {
    width: 50px;
    padding: 4px 8px;
    border: 1px solid #d0d0d0;
    border-radius: 4px;
    text-align: center;
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ§Š CSS3Dã‚µã‚¤ã‚³ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p class="lead">CSS3Dã«ã‚ˆã‚‹è»½é‡ãªæ“¬ä¼¼3Dè¡¨ç¾ã€‚æ¼”å‡ºè¨­å®šã‚’ç´°ã‹ãèª¿æ•´ã§ãã¾ã™ã€‚</p>
    </header>

    <section class="config-panel">
      <div class="config-group">
        <h3>æç”»è¨­å®š</h3>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" name="algorithm" id="algValue" value="value-first" checked>
            <label for="algValue">å‡ºç›®å…ˆè¡Œ (é«˜é€Ÿãƒ»æ­£ç¢º)</label>
          </div>
          <div class="radio-item">
            <input type="radio" name="algorithm" id="algVisual" value="visual-first">
            <label for="algVisual">æ¼”å‡ºå…ˆè¡Œ (è¦–è¦šé‡è¦–)</label>
          </div>
        </div>
      </div>
      <div class="config-group">
        <h3>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</h3>
        <div class="number-input">
          <label for="diceCount">å€‹æ•°:</label>
          <input type="number" id="diceCount" min="1" max="8" value="3">
        </div>
        <div class="number-input">
          <label for="spinCount">å›è»¢æ•°:</label>
          <input type="number" id="spinCount" min="2" max="6" value="4">
        </div>
        <div class="number-input">
          <label for="duration">æ™‚é–“(ç§’):</label>
          <input type="number" id="duration" min="0.5" max="2.0" step="0.1" value="1.2">
        </div>
      </div>
      <div class="config-group">
        <h3>åœæ­¢æŒ™å‹•</h3>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" name="stop3d" id="stopFree" value="free">
            <label for="stopFree">ãƒ•ãƒªãƒ¼ã‚¹ãƒˆãƒƒãƒ—</label>
          </div>
          <div class="radio-item">
            <input type="radio" name="stop3d" id="stopSnap" value="snap" checked>
            <label for="stopSnap">ãƒ“ã‚¿æ­¢ã‚ (æ­£ç¢ºãªè§’åº¦)</label>
          </div>
        </div>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="debugMode">
            <label for="debugMode">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</label>
          </div>
        </div>
      </div>
      <div class="config-group debug-controls" id="debugControls">
        <h3>ãƒ‡ãƒãƒƒã‚°è¨­å®š</h3>
        <label for="debugValues">å‡ºç›® (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€1-6)</label>
        <div class="debug-inputs">
          <input type="text" id="debugValues" placeholder="ä¾‹: 6,6,6">
        </div>
      </div>
    </section>

    <section class="dice-container">
      <div id="diceBoard" class="board-3d"></div>
      <div class="actions">
        <button id="rollBtn" class="btn-primary">ãƒ­ãƒ¼ãƒ«ã™ã‚‹ (Space)</button>
        <button id="resetBtn" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div id="results" class="results"></div>
    </section>
  </div>

<script>
(() => {
  const diceBoard = document.getElementById('diceBoard');
  const resultsEl = document.getElementById('results');
  const rollBtn = document.getElementById('rollBtn');
  const resetBtn = document.getElementById('resetBtn');
  const diceCountInput = document.getElementById('diceCount');
  const spinCountInput = document.getElementById('spinCount');
  const durationInput = document.getElementById('duration');
  const debugModeCheck = document.getElementById('debugMode');
  const debugControls = document.getElementById('debugControls');
  const debugValuesInput = document.getElementById('debugValues');
  const algValue = document.getElementById('algValue');
  const algVisual = document.getElementById('algVisual');
  const stopFree = document.getElementById('stopFree');
  const stopSnap = document.getElementById('stopSnap');

  const state = {
    diceCount: Number(diceCountInput.value) || 3,
    spinCount: Number(spinCountInput.value) || 4,
    duration: Number(durationInput.value) || 1.2,
    algorithm: 'value-first',
    stop3d: 'snap',
    diceElements: [],
    isRolling: false,
    debugMode: false
  };

  function randint1n(n) {
    if (crypto?.getRandomValues) {
      const max = 0xFFFFFFFF;
      const limit = Math.floor(max / n) * n;
      const buf = new Uint32Array(1);
      for (;;) {
        crypto.getRandomValues(buf);
        if (buf[0] < limit) return (buf[0] % n) + 1;
      }
    }
    return Math.floor(Math.random() * n) + 1;
  }

  function getPipPositions(value) {
    const map = {
      1: [5],
      2: [1, 9],
      3: [1, 5, 9],
      4: [1, 3, 7, 9],
      5: [1, 3, 5, 7, 9],
      6: [1, 3, 4, 6, 7, 9]
    };
    return map[value] || [5];
  }

  function createDie3D() {
    const wrap = document.createElement('div');
    wrap.className = 'die-wrap-3d';
    const cube = document.createElement('div');
    cube.className = 'cube';
    wrap.appendChild(cube);

    const faces = [
      { cls: 'f-front',  value: 1, pips: [5] },
      { cls: 'f-back',   value: 6, pips: [1, 3, 4, 6, 7, 9] },
      { cls: 'f-right',  value: 3, pips: [1, 5, 9] },
      { cls: 'f-left',   value: 4, pips: [1, 3, 7, 9] },
      { cls: 'f-top',    value: 5, pips: [1, 3, 5, 7, 9] },
      { cls: 'f-bottom', value: 2, pips: [1, 9] }
    ];

    for (const f of faces) {
      const face = document.createElement('div');
      face.className = `face ${f.cls}`;
      face.setAttribute('data-value', f.value);
      for (const pos of f.pips) {
        const pip = document.createElement('div');
        pip.className = `pip p${pos}`;
        face.appendChild(pip);
      }
      cube.appendChild(face);
    }

    return { wrap, cube };
  }

  const ORIENT_3D = {
    1: { x: 0,   y: 0,   z: 0 },
    2: { x: 90,  y: 0,   z: 0 },
    3: { x: 0,   y: -90, z: 0 },
    4: { x: 0,   y: 90,  z: 0 },
    5: { x: -90, y: 0,   z: 0 },
    6: { x: 0,   y: 180, z: 0 }
  };

  function initBoard() {
    diceBoard.innerHTML = '';
    state.diceElements = [];
    resultsEl.style.display = 'none';

    for (let i = 0; i < state.diceCount; i++) {
      const { wrap, cube } = createDie3D();
      cube.style.transform = 'rotateX(-20deg) rotateY(30deg)';
      diceBoard.appendChild(wrap);
      state.diceElements.push(cube);
    }
  }

  function getTargetValues() {
    if (state.debugMode) {
      const input = debugValuesInput.value.trim();
      if (input) {
        const parsed = input.split(',').map(v => {
          const n = parseInt(v.trim(), 10);
          return (n >= 1 && n <= 6) ? n : randint1n(6);
        });
        while (parsed.length < state.diceCount) {
          parsed.push(randint1n(6));
        }
        return parsed.slice(0, state.diceCount);
      }
    }
    return Array.from({ length: state.diceCount }, () => randint1n(6));
  }

  function showResults(values, total) {
    resultsEl.style.display = 'block';
    resultsEl.innerHTML = `
      <div>åˆè¨ˆ: <strong>${total}</strong></div>
      <div class="results-detail">å‡ºç›®: ${values.join(', ')}</div>
    `;
  }

  function roll3DValueFirst() {
    const cubes = state.diceElements;
    const values = getTargetValues();
    const useSnap = state.stop3d === 'snap';
    let remaining = cubes.length;
    let total = 0;

    cubes.forEach((cube, idx) => {
      cube.style.transition = 'none';
      cube.style.transform = 'rotateX(-20deg) rotateY(30deg)';
      void cube.offsetWidth;

      const v = values[idx];
      total += v;
      const base = ORIENT_3D[v];
      const spins = state.spinCount;
      const rx = base.x + spins * 360 + (Math.random() * 10 - 5);
      const ry = base.y + spins * 360 + (Math.random() * 10 - 5);
      const rz = useSnap ? 0 : (Math.random() * 20 - 10);

      cube.style.transition = `transform ${state.duration}s cubic-bezier(.25,1,.3,1)`;
      cube.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;

      const onEnd = () => {
        if (useSnap) {
          cube.style.transition = 'none';
          cube.style.transform = `rotateX(${base.x}deg) rotateY(${base.y}deg) rotateZ(0deg)`;
        }
        cube.removeEventListener('transitionend', onEnd);
        remaining--;
        if (remaining === 0) {
          showResults(values, total);
          state.isRolling = false;
          rollBtn.disabled = false;
        }
      };
      cube.addEventListener('transitionend', onEnd);
    });
  }

  function roll3DVisualFirst() {
    const cubes = state.diceElements;
    const values = getTargetValues();
    let remaining = cubes.length;
    let total = 0;

    cubes.forEach((cube, idx) => {
      const v = values[idx];
      total += v;
      const base = ORIENT_3D[v];
      const spins = state.spinCount;
      const rx = base.x + spins * 360 + (Math.random() * 20 - 10);
      const ry = base.y + spins * 360 + (Math.random() * 20 - 10);
      const rz = Math.random() * 180 - 90;

      cube.style.transition = `transform ${state.duration}s cubic-bezier(.2,.7,.2,1)`;
      cube.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;

      const onEnd = () => {
        cube.removeEventListener('transitionend', onEnd);
        remaining--;
        if (remaining === 0) {
          showResults(values, total);
          state.isRolling = false;
          rollBtn.disabled = false;
        }
      };
      cube.addEventListener('transitionend', onEnd);
    });
  }

  function executeRoll() {
    if (state.isRolling) return;
    state.isRolling = true;
    rollBtn.disabled = true;

    if (state.algorithm === 'value-first') {
      roll3DValueFirst();
    } else {
      roll3DVisualFirst();
    }
  }

  rollBtn.addEventListener('click', executeRoll);
  resetBtn.addEventListener('click', () => {
    state.isRolling = false;
    rollBtn.disabled = false;
    initBoard();
  });

  ;[algValue, algVisual].forEach(input => {
    input.addEventListener('change', (e) => {
      state.algorithm = e.target.value;
    });
  });

  ;[stopFree, stopSnap].forEach(input => {
    input.addEventListener('change', (e) => {
      state.stop3d = e.target.value;
    });
  });

  diceCountInput.addEventListener('change', (e) => {
    const next = Math.max(1, Math.min(8, parseInt(e.target.value, 10) || 1));
    state.diceCount = next;
    diceCountInput.value = next;
    initBoard();
  });

  spinCountInput.addEventListener('change', (e) => {
    const next = Math.max(2, Math.min(6, parseInt(e.target.value, 10) || 4));
    state.spinCount = next;
    spinCountInput.value = next;
  });

  durationInput.addEventListener('change', (e) => {
    const next = Math.max(0.5, Math.min(2.0, parseFloat(e.target.value) || 1.2));
    state.duration = next;
    durationInput.value = next;
  });

  debugModeCheck.addEventListener('change', (e) => {
    state.debugMode = e.target.checked;
    debugControls.style.display = state.debugMode ? 'block' : 'none';
  });

  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      executeRoll();
    }
  });

  initBoard();
})();
</script>
</body>
</html>
