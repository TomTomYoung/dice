# サイコロシミュレーター統合案

## 概要
4つの既存サイコロアプリケーションを統合し、描画方式・アルゴリズム・演出を自由に組み合わせられる包括的なシステム。

## 統合の軸

### 1. 描画方式（Rendering Mode）【排他的】

#### 2D（フラット）
- **元ファイル**: `出目先行ビタすけ`
- **特徴**: CSS Grid + 平面的なピップ配置
- **パフォーマンス**: 軽量・高速
- **視覚効果**: シンプルな揺れアニメーション
- **用途**: シンプルなUI、モバイル最適化

#### 3D（立体）
- **元ファイル**: `CSS3D先行`, `出目先行剰余転がし`, `剰余転がし複数`
- **特徴**: CSS 3D Transform + preserve-3d
- **パフォーマンス**: 中〜重（デバイス依存）
- **視覚効果**: リアルな回転・遠近感
- **用途**: デスクトップ、視覚重視

---

### 2. アルゴリズム（Algorithm）【排他的】

#### 出目先行（Value-First）
- **元ファイル**: `出目先行剰余転がし`, `剰余転がし複数`
- **処理フロー**:
  1. 乱数で出目を確定
  2. 出目に対応する回転角度を計算
  3. アニメーション実行
- **利点**:
  - 結果が保証される（正確性）
  - デバッグモードで任意出目を指定可能
  - ビタ止めと相性が良い
- **欠点**:
  - 演出の自由度がやや低い

#### 演出先行（Visual-First）
- **元ファイル**: `CSS3D先行`
- **処理フロー**:
  1. ランダムな回転アニメーション実行
  2. 最終的な姿勢から出目を決定/表示
- **利点**:
  - 自然な演出
  - ランダム性の視覚的表現
- **欠点**:
  - 任意出目指定が困難
  - 2Dでは効果が限定的

---

### 3. 3D停止処理（Stop Method）【3D専用・排他的】

#### フリーストップ（Free Stop）
- **元ファイル**: `CSS3D先行`
- **動作**: アニメーション終了位置にそのまま停止
- **特徴**:
  - 自然な物理挙動を模倣
  - わずかなズレや傾きが残る
  - transitionend後の処理なし

#### ビタ止め（Snap Stop）
- **元ファイル**: `出目先行剰余転がし`, `剰余転がし複数`
- **動作**: transitionend後に正確な角度へスナップ
- **特徴**:
  - 出目が正面にピッタリ収まる
  - 視認性向上
  - わずかな不自然さ（物理的でない）

---

## 共通機能（すべての組み合わせで利用可能）

### 基本設定
| 項目 | 範囲 | デフォルト | 説明 |
|------|------|------------|------|
| **個数** | 1-12 | 3 | サイコロの個数 |
| **回転数** | 2-6 | 4 | 回転の多さ（演出の長さ） |
| **時間** | 0.5-2.0秒 | 1.2秒 | アニメーション時間 |

### 操作
- **振るボタン**: サイコロをロール
- **スペースキー**: ショートカット
- **リセットボタン**: 初期状態に戻す

### 結果表示
- 各サイコロの出目
- 合計値の表示
- aria-liveによる読み上げ対応

### デバッグモード
- 任意出目指定（例: `6,6,6`）
- カンマ区切りで入力
- 不正な値は自動的にランダム化
- **制限**: 出目先行アルゴリズムでのみ完全動作

### 暗号学的乱数
- `crypto.getRandomValues()` を優先使用
- rejection samplingで偏りを除去
- フォールバック: `Math.random()`

---

## 組み合わせマトリクス

### 有効な組み合わせ

| 描画 | アルゴリズム | 3D停止 | 動作 | 推奨用途 |
|------|-------------|--------|------|----------|
| 2D | 出目先行 | - | ○ | シンプル・高速 |
| 2D | 演出先行 | - | ○ | 2Dでは差が小さい |
| 3D | 出目先行 | フリー | ○ | バランス型 |
| 3D | 出目先行 | ビタ | ◎ | **推奨構成** |
| 3D | 演出先行 | フリー | ○ | リアル志向 |
| 3D | 演出先行 | ビタ | △ | やや不自然 |

### 機能制限マトリクス

| 機能 | 2D | 3D |
|------|----|----|
| ビタ止め | N/A | ○ |
| デバッグモード（任意出目） | ○ | ○ |
| 回転数変更 | ○ | ○ |
| 時間変更 | ○ | ○ |

---

## 実装アーキテクチャ

### 状態管理
```javascript
const state = {
  renderMode: '3d',          // '2d' | '3d'
  algorithm: 'value-first',  // 'value-first' | 'visual-first'
  stop3d: 'snap',            // 'free' | 'snap'
  diceCount: 3,              // 1-12
  spinCount: 4,              // 2-6
  duration: 1.2,             // 0.5-2.0
  debugMode: false,
  isRolling: false,
  diceElements: []
};
```

### 関数構成

#### 共通関数
- `randint1n(n)`: 暗号学的乱数生成
- `getPipPositions(value)`: ピップ配置マップ
- `getTargetValues()`: デバッグモード対応の出目取得
- `showResults(values, total)`: 結果表示

#### 描画関連
- `createDie2D(value)`: 2Dサイコロ生成
- `createDie3D()`: 3D立方体生成（6面構築）
- `initBoard()`: ボード初期化

#### ロール関数
- `roll2D()`: 2D用ロール処理
- `roll3DValueFirst()`: 3D出目先行ロール
- `roll3DVisualFirst()`: 3D演出先行ロール
- `executeRoll()`: 統合エントリーポイント

### 3D回転角度マッピング
```javascript
const ORIENT_3D = {
  1: { x: 0,   y: 0,   z: 0 },    // front
  2: { x: 90,  y: 0,   z: 0 },    // bottom
  3: { x: 0,   y: -90, z: 0 },    // right
  4: { x: 0,   y: 90,  z: 0 },    // left
  5: { x: -90, y: 0,   z: 0 },    // top
  6: { x: 0,   y: 180, z: 0 }     // back
};
```

---

## UIフロー

### 初期化
1. デフォルト設定読み込み（3D・出目先行・ビタ止め）
2. ボード構築（3個のサイコロ）
3. 初期姿勢設定（俯瞰視点）

### ロール実行
1. ボタンクリック or スペースキー
2. `isRolling` フラグ設定、ボタン無効化
3. 現在の設定に基づいて適切なロール関数呼び出し
4. アニメーション実行
5. 結果表示、フラグ解除、ボタン有効化

### 設定変更
- 描画方式変更 → ボード再構築
- 個数変更 → ボード再構築
- その他 → 次回ロール時に反映

---

## 拡張性

### 追加可能な機能
1. **新しいサイコロ種類**
   - D4, D8, D10, D12, D20対応
   - 多面体アルゴリズムの追加

2. **演出効果**
   - パーティクル効果
   - サウンド効果
   - バウンス物理演算

3. **統計機能**
   - 出目の履歴記録
   - 確率分布グラフ
   - カイ二乗検定

4. **保存機能**
   - 設定のlocalStorage保存
   - 履歴のエクスポート

5. **マルチプレイヤー**
   - WebSocketで同期
   - ルーム機能

---

## パフォーマンス最適化

### 現在の実装
- DOM再利用（ボード再構築時以外）
- transition終了イベントで同期
- perspective設定でGPU加速

### 改善案
1. **Web Worker**
   - 乱数生成をバックグラウンド化
   
2. **Canvas/WebGL**
   - 多数のサイコロで有利
   - より複雑な3D演出

3. **IntersectionObserver**
   - 画面外のサイコロは更新停止

---

## ブラウザ互換性

### 必須機能
- CSS Grid
- CSS 3D Transforms（3Dモード）
- ES6+（arrow function, template literals）
- crypto.getRandomValues

### 対応ブラウザ
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+
- モバイルブラウザ（iOS Safari 14+, Chrome Android）

### フォールバック
- `crypto.getRandomValues` 非対応 → `Math.random()`
- 3D非対応 → 2Dモードへの切り替え推奨

---

## 推奨設定

### 用途別推奨

#### 1. 一般ユーザー向け（デフォルト）
- **描画**: 3D
- **アルゴリズム**: 出目先行
- **停止**: ビタ止め
- **個数**: 2-3個
- **時間**: 1.2秒

#### 2. パフォーマンス重視
- **描画**: 2D
- **アルゴリズム**: 出目先行
- **個数**: 1-6個
- **時間**: 0.8秒

#### 3. 視覚重視
- **描画**: 3D
- **アルゴリズム**: 演出先行
- **停止**: フリー
- **個数**: 1-2個
- **時間**: 1.5-2.0秒
- **回転数**: 5-6回

#### 4. デバッグ・テスト用
- **デバッグモード**: ON
- **アルゴリズム**: 出目先行（必須）
- **任意出目**: 指定値

---

## まとめ

この統合案により、以下が実現されます:

✅ **柔軟性**: 用途に応じて最適な組み合わせを選択  
✅ **拡張性**: 新機能の追加が容易  
✅ **保守性**: モジュラー設計で各機能が独立  
✅ **互換性**: 既存ファイルの機能をすべて包含  
✅ **ユーザビリティ**: 直感的なUI、キーボードショートカット  

排他的な組み合わせは適切に制御され、どの設定でも安定動作します。
