<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç‰©ç†æ¼”ç®—ã‚µã‚¤ã‚³ãƒ­ - ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    overflow-x: hidden;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  header {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
  }

  h1 {
    font-size: 28px;
    font-weight: 700;
    color: #667eea;
    text-align: center;
    margin-bottom: 10px;
  }

  .subtitle {
    text-align: center;
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
  }

  /* ã‚¿ãƒ– */
  .tabs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: #e0e0e0;
    color: #666;
    transition: all 0.3s;
  }

  .tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .tab-btn:hover:not(.active) {
    background: #d0d0d0;
  }

  /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .tab-content {
    display: none;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
  }

  .tab-content.active {
    display: block;
  }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
  .control-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  .control-group {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }

  .control-group h3 {
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .control-item {
    margin-bottom: 10px;
  }

  .control-item label {
    display: block;
    font-size: 13px;
    color: #555;
    margin-bottom: 5px;
  }

  .control-item input[type="number"],
  .control-item input[type="text"],
  .control-item input[type="color"],
  .control-item select {
    width: 100%;
    padding: 8px;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 14px;
  }

  .control-item input[type="range"] {
    width: 100%;
  }

  .range-value {
    display: inline-block;
    min-width: 40px;
    text-align: right;
    font-weight: 600;
    color: #667eea;
  }

  /* ãƒœã‚¿ãƒ³ */
  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
  }

  button {
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: #64748b;
    color: white;
  }

  .btn-secondary:hover {
    background: #475569;
  }

  .btn-success {
    background: #10b981;
    color: white;
  }

  .btn-success:hover {
    background: #059669;
  }

  /* Canvas */
  #canvas-container {
    position: relative;
    width: 100%;
    height: 600px;
    background: linear-gradient(to bottom, #87ceeb 0%, #98d8e8 100%);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }

  canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* çµæœè¡¨ç¤º */
  .results {
    margin-top: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .results h2 {
    font-size: 18px;
    color: #667eea;
    margin-bottom: 15px;
  }

  .result-main {
    font-size: 24px;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
  }

  .result-detail {
    font-size: 16px;
    color: #666;
    margin-bottom: 5px;
  }

  /* å±¥æ­´ */
  .history {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
  }

  .history h3 {
    font-size: 14px;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 10px;
  }

  .history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
  }

  .history-item {
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 13px;
  }

  /* é¢ç·¨é›†UI */
  .face-editor {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .face-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .face-input-group label {
    min-width: 50px;
    font-weight: 600;
    color: #667eea;
  }

  .face-input-group input {
    flex: 1;
  }

  /* ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
  .preset-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }

  .preset-btn {
    padding: 10px;
    background: white;
    border: 2px solid #667eea;
    color: #667eea;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .preset-btn:hover {
    background: #667eea;
    color: white;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    #canvas-container {
      height: 400px;
    }

    .control-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <header>
    <h1>ğŸ² ç‰©ç†æ¼”ç®—ã‚µã‚¤ã‚³ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p class="subtitle">Three.js + Cannon.js ã«ã‚ˆã‚‹æœ¬æ ¼çš„ãªç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³æ­è¼‰</p>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="play">ğŸ® ãƒ—ãƒ¬ã‚¤</button>
      <button class="tab-btn" data-tab="dice">ğŸ¨ ã‚µã‚¤ã‚³ãƒ­å¤–è¦³</button>
      <button class="tab-btn" data-tab="faces">âœï¸ é¢ã®ç·¨é›†</button>
      <button class="tab-btn" data-tab="throw">ğŸš€ æŠ•ã’æ–¹</button>
      <button class="tab-btn" data-tab="presets">â­ ãƒ—ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ã‚¿ãƒ– -->
    <div class="tab-content active" data-content="play">
      <div class="control-grid">
        <div class="control-group">
          <h3>åŸºæœ¬è¨­å®š</h3>
          <div class="control-item">
            <label>ã‚µã‚¤ã‚³ãƒ­ã®å€‹æ•°</label>
            <input type="number" id="diceCount" min="1" max="10" value="3">
          </div>
          <div class="control-item">
            <label>é‡åŠ›</label>
            <input type="range" id="gravity" min="5" max="30" value="15" step="1">
            <span class="range-value" id="gravityValue">15</span> m/sÂ²
          </div>
        </div>

        <div class="control-group">
          <h3>ã‚«ãƒ¡ãƒ©æ“ä½œ</h3>
          <p style="font-size: 12px; color: #666; line-height: 1.5;">
            â€¢ ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°: è¦–ç‚¹å›è»¢<br>
            â€¢ ãƒ›ã‚¤ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ <br>
            â€¢ å³ã‚¯ãƒªãƒƒã‚¯ãƒ‰ãƒ©ãƒƒã‚°: ãƒ‘ãƒ³
          </p>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn-primary" id="rollBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ (Space)</button>
        <button class="btn-secondary" id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn-secondary" id="clearHistoryBtn">ğŸ—‘ï¸ å±¥æ­´ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- ã‚µã‚¤ã‚³ãƒ­å¤–è¦³ã‚¿ãƒ– -->
    <div class="tab-content" data-content="dice">
      <div class="control-grid">
        <div class="control-group">
          <h3>ã‚µã‚¤ã‚³ãƒ­ã®è‰²</h3>
          <div class="control-item">
            <label>æœ¬ä½“ã®è‰²</label>
            <input type="color" id="diceColor" value="#ffffff">
          </div>
          <div class="control-item">
            <label>é€æ˜åº¦</label>
            <input type="range" id="diceOpacity" min="0" max="100" value="100" step="5">
            <span class="range-value" id="diceOpacityValue">100</span>%
          </div>
        </div>

        <div class="control-group">
          <h3>ãƒ”ãƒƒãƒ—ï¼ˆç‚¹ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«</h3>
          <div class="control-item">
            <label>ãƒ”ãƒƒãƒ—ã®è‰²</label>
            <input type="color" id="pipColor" value="#000000">
          </div>
          <div class="control-item">
            <label>ãƒ”ãƒƒãƒ—ã®å½¢çŠ¶</label>
            <select id="pipShape">
              <option value="sphere">çƒä½“</option>
              <option value="cylinder">å††æŸ±</option>
              <option value="box">å››è§’</option>
            </select>
          </div>
          <div class="control-item">
            <label>ãƒ”ãƒƒãƒ—ã®ã‚µã‚¤ã‚º</label>
            <input type="range" id="pipSize" min="5" max="20" value="10" step="1">
            <span class="range-value" id="pipSizeValue">10</span>
          </div>
        </div>

        <div class="control-group">
          <h3>æè³ª</h3>
          <div class="control-item">
            <label>å…‰æ²¢åº¦</label>
            <input type="range" id="shininess" min="0" max="100" value="30" step="5">
            <span class="range-value" id="shininessValue">30</span>
          </div>
          <div class="control-item">
            <label>è§’ã®ä¸¸ã¿</label>
            <input type="range" id="roundness" min="0" max="10" value="2" step="1">
            <span class="range-value" id="roundnessValue">2</span>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn-success" id="applyStyleBtn">âœ¨ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨</button>
      </div>
    </div>

    <!-- é¢ã®ç·¨é›†ã‚¿ãƒ– -->
    <div class="tab-content" data-content="faces">
      <div class="control-group">
        <h3>å„é¢ã®ãƒ†ã‚­ã‚¹ãƒˆ/è¨˜å·ã‚’ç·¨é›†</h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
          é€šå¸¸ã®æ•°å­—ã®ä»£ã‚ã‚Šã«ã€æ–‡å­—ã‚„è¨˜å·ã€çµµæ–‡å­—ã‚’è¨­å®šã§ãã¾ã™
        </p>
        <div class="face-editor">
          <div class="face-input-group">
            <label>é¢1:</label>
            <input type="text" id="face1" value="1" maxlength="3">
          </div>
          <div class="face-input-group">
            <label>é¢2:</label>
            <input type="text" id="face2" value="2" maxlength="3">
          </div>
          <div class="face-input-group">
            <label>é¢3:</label>
            <input type="text" id="face3" value="3" maxlength="3">
          </div>
          <div class="face-input-group">
            <label>é¢4:</label>
            <input type="text" id="face4" value="4" maxlength="3">
          </div>
          <div class="face-input-group">
            <label>é¢5:</label>
            <input type="text" id="face5" value="5" maxlength="3">
          </div>
          <div class="face-input-group">
            <label>é¢6:</label>
            <input type="text" id="face6" value="6" maxlength="3">
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn-success" id="applyFacesBtn">âœ¨ é¢ã®è¨­å®šã‚’é©ç”¨</button>
      </div>
    </div>

    <!-- æŠ•ã’æ–¹ã‚¿ãƒ– -->
    <div class="tab-content" data-content="throw">
      <div class="control-grid">
        <div class="control-group">
          <h3>æŠ•ã’ã‚‹åŠ›</h3>
          <div class="control-item">
            <label>åŠ›ã®å¼·ã•</label>
            <input type="range" id="throwForce" min="1" max="20" value="8" step="0.5">
            <span class="range-value" id="throwForceValue">8</span>
          </div>
          <div class="control-item">
            <label>å›è»¢ã®å¼·ã•</label>
            <input type="range" id="throwSpin" min="0" max="20" value="10" step="1">
            <span class="range-value" id="throwSpinValue">10</span>
          </div>
        </div>

        <div class="control-group">
          <h3>æŠ•ã’ã‚‹æ–¹å‘</h3>
          <div class="control-item">
            <label>æ¨ªæ–¹å‘ã®ã°ã‚‰ã¤ã</label>
            <input type="range" id="throwSpread" min="0" max="10" value="5" step="0.5">
            <span class="range-value" id="throwSpreadValue">5</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¿ãƒ– -->
    <div class="tab-content" data-content="presets">
      <div class="control-group">
        <h3>ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ</h3>
        <div class="preset-buttons">
          <button class="preset-btn" data-preset="normal">ğŸ² é€šå¸¸ (1-6)</button>
          <button class="preset-btn" data-preset="trump">ğŸƒ ãƒˆãƒ©ãƒ³ãƒ—é¢¨ (A,K,Q,J,10,9)</button>
          <button class="preset-btn" data-preset="emoji">ğŸ˜€ çµµæ–‡å­—</button>
          <button class="preset-btn" data-preset="alphabet">ğŸ”¤ ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ (A-F)</button>
          <button class="preset-btn" data-preset="symbols">ğŸ”£ è¨˜å·</button>
          <button class="preset-btn" data-preset="zero">â­• 0-5</button>
        </div>
      </div>
    </div>
  </header>

  <div style="padding: 20px;">
    <div id="canvas-container"></div>

    <div class="results">
      <h2>ğŸ“Š çµæœ</h2>
      <div id="resultDisplay">
        <div class="result-main">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„</div>
      </div>

      <div class="history">
        <h3>ğŸ•’ ãƒ­ãƒ¼ãƒ«å±¥æ­´</h3>
        <div class="history-list" id="historyList">
          <div style="color: #999; font-size: 13px;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<!-- Cannon.js -->
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
<!-- OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

<script>
(() => {
  'use strict';

  // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ =====
  const state = {
    diceCount: 3,
    gravity: 15,
    diceColor: '#ffffff',
    diceOpacity: 1.0,
    pipColor: '#000000',
    pipShape: 'sphere',
    pipSize: 10,
    shininess: 30,
    roundness: 2,
    faceTexts: ['1', '2', '3', '4', '5', '6'],
    throwForce: 8,
    throwSpin: 10,
    throwSpread: 5,
    isRolling: false,
    history: []
  };

  // ===== Three.js / Cannon.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
  let scene, camera, renderer, world, controls;
  let dice = [];
  let floor;

  const container = document.getElementById('canvas-container');

  function initThreeJS() {
    // ã‚·ãƒ¼ãƒ³
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);

    // ã‚«ãƒ¡ãƒ©
    camera = new THREE.PerspectiveCamera(
      45,
      container.clientWidth / container.clientHeight,
      0.1,
      1000
    );
    camera.position.set(0, 15, 30);
    camera.lookAt(0, 0, 0);

    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    // OrbitControls
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.maxDistance = 50;
    controls.minDistance = 10;

    // ãƒ©ã‚¤ãƒˆ
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 20, 10);
    dirLight.castShadow = true;
    dirLight.shadow.camera.left = -20;
    dirLight.shadow.camera.right = 20;
    dirLight.shadow.camera.top = 20;
    dirLight.shadow.camera.bottom = -20;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    // åºŠ
    const floorGeometry = new THREE.PlaneGeometry(40, 40);
    const floorMaterial = new THREE.MeshStandardMaterial({
      color: 0x2d5016,
      roughness: 0.8
    });
    floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', onWindowResize, false);
  }

  function initCannonJS() {
    // ç‰©ç†ãƒ¯ãƒ¼ãƒ«ãƒ‰
    world = new CANNON.World();
    world.gravity.set(0, -state.gravity, 0);
    world.defaultContactMaterial.friction = 0.4;
    world.defaultContactMaterial.restitution = 0.3;

    // åºŠã®ç‰©ç†ãƒœãƒ‡ã‚£
    const floorShape = new CANNON.Plane();
    const floorBody = new CANNON.Body({ mass: 0, shape: floorShape });
    floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(floorBody);

    // å£ï¼ˆå¢ƒç•Œï¼‰ã‚’è¿½åŠ 
    const wallMaterial = new CANNON.Material();
    const wallShape = new CANNON.Plane();

    // 4ã¤ã®å£
    const walls = [
      { x: 0, y: 0, z: -20, rx: 0, ry: 0, rz: 0 },  // å¾Œã‚
      { x: 0, y: 0, z: 20, rx: 0, ry: Math.PI, rz: 0 },  // å‰
      { x: -20, y: 0, z: 0, rx: 0, ry: Math.PI/2, rz: 0 },  // å·¦
      { x: 20, y: 0, z: 0, rx: 0, ry: -Math.PI/2, rz: 0 }   // å³
    ];

    walls.forEach(w => {
      const wallBody = new CANNON.Body({ mass: 0, material: wallMaterial });
      wallBody.addShape(wallShape);
      wallBody.position.set(w.x, w.y, w.z);
      wallBody.quaternion.setFromEuler(w.rx, w.ry, w.rz);
      world.addBody(wallBody);
    });
  }

  // ===== ã‚µã‚¤ã‚³ãƒ­ä½œæˆ =====
  function createDie() {
    const size = 2;
    const radius = state.roundness / 100;

    // Three.js ãƒ¡ãƒƒã‚·ãƒ¥
    const geometry = new THREE.BoxGeometry(size, size, size);
    const material = new THREE.MeshStandardMaterial({
      color: state.diceColor,
      transparent: state.diceOpacity < 1,
      opacity: state.diceOpacity,
      roughness: (100 - state.shininess) / 100,
      metalness: 0.1
    });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.castShadow = true;
    mesh.receiveShadow = true;

    // ãƒ”ãƒƒãƒ—ã‚’è¿½åŠ 
    addPips(mesh, size);

    scene.add(mesh);

    // Cannon.js ãƒœãƒ‡ã‚£
    const shape = new CANNON.Box(new CANNON.Vec3(size/2, size/2, size/2));
    const body = new CANNON.Body({
      mass: 1,
      shape: shape,
      material: new CANNON.Material()
    });

    world.addBody(body);

    return { mesh, body };
  }

  // ===== ãƒ”ãƒƒãƒ—ï¼ˆç‚¹ï¼‰ã‚’è¿½åŠ  =====
  function addPips(diceMesh, size) {
    const pipSize = state.pipSize / 100;
    const offset = size / 2 + 0.01;

    // ãƒ”ãƒƒãƒ—ã‚¸ã‚ªãƒ¡ãƒˆãƒª
    let pipGeometry;
    if (state.pipShape === 'sphere') {
      pipGeometry = new THREE.SphereGeometry(pipSize, 16, 16);
    } else if (state.pipShape === 'cylinder') {
      pipGeometry = new THREE.CylinderGeometry(pipSize, pipSize, pipSize/2, 16);
    } else {
      pipGeometry = new THREE.BoxGeometry(pipSize*1.5, pipSize/2, pipSize*1.5);
    }

    const pipMaterial = new THREE.MeshStandardMaterial({
      color: state.pipColor,
      roughness: 0.6
    });

    // å„é¢ã®ãƒ”ãƒƒãƒ—é…ç½®
    const pipConfigs = [
      // é¢1 (å‰é¢, Z+): 1
      { face: 0, positions: [[0, 0, offset]] },
      // é¢6 (èƒŒé¢, Z-): 6
      { face: 1, positions: [
        [-size/3, size/3, -offset], [size/3, size/3, -offset],
        [-size/3, 0, -offset], [size/3, 0, -offset],
        [-size/3, -size/3, -offset], [size/3, -size/3, -offset]
      ]},
      // é¢3 (å³å´, X+): 3
      { face: 2, positions: [
        [offset, size/3, -size/3], [offset, 0, 0], [offset, -size/3, size/3]
      ]},
      // é¢4 (å·¦å´, X-): 4
      { face: 3, positions: [
        [-offset, size/3, size/3], [-offset, size/3, -size/3],
        [-offset, -size/3, size/3], [-offset, -size/3, -size/3]
      ]},
      // é¢5 (ä¸Šé¢, Y+): 5
      { face: 4, positions: [
        [-size/3, offset, -size/3], [size/3, offset, -size/3],
        [0, offset, 0],
        [-size/3, offset, size/3], [size/3, offset, size/3]
      ]},
      // é¢2 (ä¸‹é¢, Y-): 2
      { face: 5, positions: [
        [-size/3, -offset, -size/3], [size/3, -offset, size/3]
      ]}
    ];

    // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚’ä½¿ã†å ´åˆã¯ãƒ”ãƒƒãƒ—ã®ä»£ã‚ã‚Šã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
    const useText = state.faceTexts.some(t => !/^\d$/.test(t));

    if (useText) {
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: Canvas ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ç”¨
      const faceValues = [1, 6, 3, 4, 5, 2]; // å„é¢ã®å€¤
      pipConfigs.forEach((config, idx) => {
        const text = state.faceTexts[faceValues[idx] - 1];
        addTextToFace(diceMesh, config.positions[0], text, size);
      });
    } else {
      // ãƒ”ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰
      pipConfigs.forEach(config => {
        config.positions.forEach(pos => {
          const pip = new THREE.Mesh(pipGeometry, pipMaterial);
          pip.position.set(pos[0], pos[1], pos[2]);

          // ãƒ”ãƒƒãƒ—ã®å‘ãã‚’èª¿æ•´
          if (Math.abs(pos[2]) > size/3) {
            // Zè»¸æ–¹å‘
            pip.rotation.x = pos[2] > 0 ? 0 : Math.PI;
          } else if (Math.abs(pos[0]) > size/3) {
            // Xè»¸æ–¹å‘
            pip.rotation.y = pos[0] > 0 ? Math.PI/2 : -Math.PI/2;
            pip.rotation.z = Math.PI/2;
          } else {
            // Yè»¸æ–¹å‘
            pip.rotation.x = pos[1] > 0 ? Math.PI/2 : -Math.PI/2;
          }

          diceMesh.add(pip);
        });
      });
    }
  }

  // ===== é¢ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ  =====
  function addTextToFace(diceMesh, position, text, size) {
    // Canvas ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
    const canvas = document.createElement('canvas');
    canvas.width = 128;
    canvas.height = 128;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = state.diceColor;
    ctx.fillRect(0, 0, 128, 128);

    ctx.fillStyle = state.pipColor;
    ctx.font = 'bold 80px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, 64, 64);

    // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦é©ç”¨
    const texture = new THREE.CanvasTexture(canvas);
    const material = new THREE.MeshStandardMaterial({ map: texture });

    const geo = new THREE.PlaneGeometry(size * 0.8, size * 0.8);
    const textMesh = new THREE.Mesh(geo, material);
    textMesh.position.set(position[0], position[1], position[2]);

    // å‘ãã‚’èª¿æ•´
    if (Math.abs(position[2]) > size/3) {
      textMesh.rotation.x = position[2] > 0 ? 0 : Math.PI;
    } else if (Math.abs(position[0]) > size/3) {
      textMesh.rotation.y = position[0] > 0 ? Math.PI/2 : -Math.PI/2;
    } else {
      textMesh.rotation.x = position[1] > 0 ? Math.PI/2 : -Math.PI/2;
    }

    diceMesh.add(textMesh);
  }

  // ===== ã‚µã‚¤ã‚³ãƒ­ã‚’ãƒªã‚»ãƒƒãƒˆ =====
  function resetDice() {
    // æ—¢å­˜ã®ã‚µã‚¤ã‚³ãƒ­ã‚’å‰Šé™¤
    dice.forEach(die => {
      scene.remove(die.mesh);
      world.removeBody(die.body);
    });
    dice = [];

    // æ–°ã—ã„ã‚µã‚¤ã‚³ãƒ­ã‚’ä½œæˆ
    const count = state.diceCount;
    for (let i = 0; i < count; i++) {
      const die = createDie();

      // åˆæœŸä½ç½®ï¼ˆä¸Šç©ºã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼‰
      const x = (Math.random() - 0.5) * 10;
      const y = 10 + Math.random() * 5;
      const z = (Math.random() - 0.5) * 10;

      die.body.position.set(x, y, z);
      die.mesh.position.copy(die.body.position);

      // åˆæœŸå›è»¢
      const quat = new CANNON.Quaternion();
      quat.setFromEuler(
        Math.random() * Math.PI * 2,
        Math.random() * Math.PI * 2,
        Math.random() * Math.PI * 2
      );
      die.body.quaternion.copy(quat);
      die.mesh.quaternion.copy(die.body.quaternion);

      dice.push(die);
    }

    state.isRolling = false;
  }

  // ===== ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ =====
  function rollDice() {
    if (state.isRolling) return;
    state.isRolling = true;

    dice.forEach((die, i) => {
      // ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
      const x = (Math.random() - 0.5) * 8;
      const y = 10 + Math.random() * 3;
      const z = (Math.random() - 0.5) * 8;
      die.body.position.set(x, y, z);
      die.body.velocity.set(0, 0, 0);
      die.body.angularVelocity.set(0, 0, 0);

      // å›è»¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«
      const quat = new CANNON.Quaternion();
      quat.setFromEuler(
        Math.random() * Math.PI * 2,
        Math.random() * Math.PI * 2,
        Math.random() * Math.PI * 2
      );
      die.body.quaternion.copy(quat);

      // åŠ›ã‚’åŠ ãˆã‚‹
      const force = state.throwForce;
      const spread = state.throwSpread;
      const fx = (Math.random() - 0.5) * spread;
      const fy = -force;
      const fz = (Math.random() - 0.5) * spread;
      die.body.applyImpulse(new CANNON.Vec3(fx, fy, fz), die.body.position);

      // å›è»¢ã‚’åŠ ãˆã‚‹
      const spin = state.throwSpin;
      die.body.angularVelocity.set(
        (Math.random() - 0.5) * spin,
        (Math.random() - 0.5) * spin,
        (Math.random() - 0.5) * spin
      );
    });

    // 3ç§’å¾Œã«çµæœã‚’åˆ¤å®š
    setTimeout(() => {
      const results = getDiceResults();
      displayResults(results);
      state.isRolling = false;
    }, 3000);
  }

  // ===== å‡ºç›®åˆ¤å®š =====
  function getDiceResults() {
    const results = [];

    dice.forEach(die => {
      // ã‚µã‚¤ã‚³ãƒ­ã®ä¸Šå‘ããƒ™ã‚¯ãƒˆãƒ«ã‚’å–å¾—
      const upVector = new CANNON.Vec3(0, 1, 0);
      const worldUp = die.body.quaternion.vmult(upVector);

      // å„é¢ã®æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ï¼‰
      const faceNormals = [
        new CANNON.Vec3(0, 0, 1),   // é¢1 (å‰)
        new CANNON.Vec3(0, 0, -1),  // é¢6 (å¾Œ)
        new CANNON.Vec3(1, 0, 0),   // é¢3 (å³)
        new CANNON.Vec3(-1, 0, 0),  // é¢4 (å·¦)
        new CANNON.Vec3(0, 1, 0),   // é¢5 (ä¸Š)
        new CANNON.Vec3(0, -1, 0)   // é¢2 (ä¸‹)
      ];

      const faceValues = [1, 6, 3, 4, 5, 2];

      // ä¸Šã‚’å‘ã„ã¦ã„ã‚‹é¢ã‚’æ¢ã™
      let maxDot = -Infinity;
      let topFace = 1;

      faceNormals.forEach((normal, idx) => {
        const worldNormal = die.body.quaternion.vmult(normal);
        const dot = worldNormal.dot(new CANNON.Vec3(0, 1, 0));
        if (dot > maxDot) {
          maxDot = dot;
          topFace = faceValues[idx];
        }
      });

      results.push(topFace);
    });

    return results;
  }

  // ===== çµæœè¡¨ç¤º =====
  function displayResults(results) {
    const total = results.reduce((sum, v) => {
      const num = parseInt(state.faceTexts[v - 1]);
      return sum + (isNaN(num) ? 0 : num);
    }, 0);

    const displayValues = results.map(v => state.faceTexts[v - 1]);

    const resultDisplay = document.getElementById('resultDisplay');
    resultDisplay.innerHTML = `
      <div class="result-main">åˆè¨ˆ: ${total || displayValues.join(' + ')}</div>
      <div class="result-detail">å‡ºç›®: ${displayValues.join(', ')}</div>
      <div class="result-detail">å€‹æ•°: ${results.length}å€‹</div>
    `;

    // å±¥æ­´ã«è¿½åŠ 
    const timestamp = new Date().toLocaleTimeString('ja-JP');
    state.history.unshift({
      time: timestamp,
      results: displayValues,
      total: total
    });

    // å±¥æ­´ã¯æœ€å¤§20ä»¶
    if (state.history.length > 20) {
      state.history.pop();
    }

    updateHistoryDisplay();
  }

  // ===== å±¥æ­´è¡¨ç¤ºæ›´æ–° =====
  function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');

    if (state.history.length === 0) {
      historyList.innerHTML = '<div style="color: #999; font-size: 13px;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    historyList.innerHTML = state.history.map(h => `
      <div class="history-item">
        <strong>${h.time}</strong> - ${h.results.join(', ')}
        ${h.total ? `(åˆè¨ˆ: ${h.total})` : ''}
      </div>
    `).join('');
  }

  // ===== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— =====
  function animate() {
    requestAnimationFrame(animate);

    // ç‰©ç†æ¼”ç®—ã‚’é€²ã‚ã‚‹
    world.step(1/60);

    // Three.jsãƒ¡ãƒƒã‚·ãƒ¥ã®ä½ç½®ãƒ»å›è»¢ã‚’æ›´æ–°
    dice.forEach(die => {
      die.mesh.position.copy(die.body.position);
      die.mesh.quaternion.copy(die.body.quaternion);
    });

    controls.update();
    renderer.render(scene, camera);
  }

  // ===== ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ =====
  function onWindowResize() {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  }

  // ===== UI ã‚¤ãƒ™ãƒ³ãƒˆ =====

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      btn.classList.add('active');
      document.querySelector(`[data-content="${tab}"]`).classList.add('active');
    });
  });

  // ãƒ¬ãƒ³ã‚¸ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤è¡¨ç¤º
  const rangeInputs = [
    { id: 'gravity', valueId: 'gravityValue', stateProp: 'gravity' },
    { id: 'diceOpacity', valueId: 'diceOpacityValue', stateProp: 'diceOpacity', transform: v => v/100 },
    { id: 'pipSize', valueId: 'pipSizeValue', stateProp: 'pipSize' },
    { id: 'shininess', valueId: 'shininessValue', stateProp: 'shininess' },
    { id: 'roundness', valueId: 'roundnessValue', stateProp: 'roundness' },
    { id: 'throwForce', valueId: 'throwForceValue', stateProp: 'throwForce' },
    { id: 'throwSpin', valueId: 'throwSpinValue', stateProp: 'throwSpin' },
    { id: 'throwSpread', valueId: 'throwSpreadValue', stateProp: 'throwSpread' }
  ];

  rangeInputs.forEach(input => {
    const el = document.getElementById(input.id);
    const valEl = document.getElementById(input.valueId);

    el.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      valEl.textContent = value;
      state[input.stateProp] = input.transform ? input.transform(value) : value;

      if (input.id === 'gravity') {
        world.gravity.set(0, -value, 0);
      }
    });
  });

  // è‰²å¤‰æ›´
  document.getElementById('diceColor').addEventListener('change', (e) => {
    state.diceColor = e.target.value;
  });

  document.getElementById('pipColor').addEventListener('change', (e) => {
    state.pipColor = e.target.value;
  });

  document.getElementById('pipShape').addEventListener('change', (e) => {
    state.pipShape = e.target.value;
  });

  // ã‚µã‚¤ã‚³ãƒ­å€‹æ•°
  document.getElementById('diceCount').addEventListener('change', (e) => {
    state.diceCount = Math.max(1, Math.min(10, parseInt(e.target.value) || 1));
    resetDice();
  });

  // ãƒœã‚¿ãƒ³
  document.getElementById('rollBtn').addEventListener('click', rollDice);
  document.getElementById('resetBtn').addEventListener('click', resetDice);
  document.getElementById('clearHistoryBtn').addEventListener('click', () => {
    state.history = [];
    updateHistoryDisplay();
  });

  // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
  document.getElementById('applyStyleBtn').addEventListener('click', () => {
    resetDice();
    alert('âœ¨ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã—ã¾ã—ãŸï¼');
  });

  // é¢ã®ãƒ†ã‚­ã‚¹ãƒˆé©ç”¨
  document.getElementById('applyFacesBtn').addEventListener('click', () => {
    for (let i = 1; i <= 6; i++) {
      const input = document.getElementById(`face${i}`);
      state.faceTexts[i - 1] = input.value || i.toString();
    }
    resetDice();
    alert('âœ¨ é¢ã®è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸï¼');
  });

  // ãƒ—ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const preset = btn.dataset.preset;

      const presets = {
        normal: ['1', '2', '3', '4', '5', '6'],
        trump: ['A', 'K', 'Q', 'J', '10', '9'],
        emoji: ['ğŸ˜€', 'ğŸ˜', 'ğŸ‰', 'â¤ï¸', 'â­', 'ğŸ”¥'],
        alphabet: ['A', 'B', 'C', 'D', 'E', 'F'],
        symbols: ['â—‹', 'â–³', 'â–¡', 'â—‡', 'â˜†', 'â™ª'],
        zero: ['0', '1', '2', '3', '4', '5']
      };

      if (presets[preset]) {
        state.faceTexts = presets[preset];
        for (let i = 1; i <= 6; i++) {
          document.getElementById(`face${i}`).value = state.faceTexts[i - 1];
        }
        resetDice();
        alert(`âœ¨ ãƒ—ãƒªã‚»ãƒƒãƒˆã€Œ${btn.textContent}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸï¼`);
      }
    });
  });

  // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§æŒ¯ã‚‹
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !state.isRolling) {
      e.preventDefault();
      rollDice();
    }
  });

  // ===== åˆæœŸåŒ– =====
  initThreeJS();
  initCannonJS();
  resetDice();
  animate();

})();
</script>
</body>
</html>
